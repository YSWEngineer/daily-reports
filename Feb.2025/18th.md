# 2025/02/18(火)
## 📚 プラクティス『Ruby中級』


## 🧩 タスクばらし
- [x] プラクティスの内容を咀嚼
- [x] タスクばらし、スモールステップの作成
- [x] 各参考ページを確認
- [ ] 参考書籍：[プロを目指す人のためのRuby入門 <改訂2版>](https://www.amazon.co.jp/dp/4297124378/)を読んで、実際に手を動かしてツールを使ってみてコードを書いてみる


## 🐾 スモールステップ
<details><summary>プラクティスの内容を咀嚼</summary>

- [x] プラクティスの内容を咀嚼
</details>

<details><summary>タスクばらし、スモールステップの作成</summary>

- [x] タスクばらし、スモールステップの作成
</details>

<details><summary>各参考ページを確認</summary>

- [x] [学習を加速させるインデックス読書術](https://qiita.com/dkatsura/items/3364b293ed1451a66a8a)を再読
- [x] 動画：[著者自身が語る「プロを目指す人のためのRuby入門」の効果的な読み方](https://www.youtube.com/watch?v=qqqbHXarPO8)
</details>

<details><summary>参考書籍：プロを目指す人のためのRuby入門 <改訂2版>を読んで、実際に手を動かしてツールを使ってみてコードを書いてみる</summary>

- [x] 第1章  本書を読み進める前に
   - [x] 1.1 イントロダクション
   - [x] 1.2 本書の概要
   - [x] 1.3 Ruby について
   - [x] 1.4 Ruby のインストール
   - [x] 1.5 エディタ/IDE について
   - [x] 1.6 Ruby を動かしてみる
   - [x] 1.7 本書のサンプルコードについて
   - [x] 1.8 Ruby の公式リファレンスについて
   - [x] 1.9 この章のまとめ
- [x] 第2章  Ruby の基礎を理解する
   - [x] 2.1 イントロダクション
   - [x] 2.2 Ruby に関する基礎知識
   - [x] 2.3 文字列
   - [x] 2.4 数値
   - [x] 2.5 真偽値と条件分岐
   - [x] 2.6 メソッドの定義
   - [x] 2.7 例題：FizzBuzzプログラムを作成する
   - [x] 2.8 文字列についてもっと詳しく
   - [x] 2.9 数値についてもっと詳しく
   - [x] 2.10 真偽値と条件分岐についてもっと詳しく
   - [x] 2.11 メソッド定義についてもっと詳しく
   - [x] 2.12 そのほかの基礎知識
   - [x] 2.13 この章のまとめ
- [x] 第3章  テストを自動化する
   - [x] 3.1 イントロダクション
   - [x] 3.2 Minitest の基本
   - [x] 3.3 FizzBuzzプログラムのテスト自動化
   - [x] 3.4 この章のまとめ
- [x] 第4章  配列や繰り返し処理を理解する
   - [x] 4.1 イントロダクション
   - [x] 4.2 配列
   - [x] 4.3 ブロック
   - [x] 4.4 ブロックを使う配列のメソッド
   - [x] 4.5 範囲（Range）
   - [x] 4.6 例題：RGB変換プログラムを作成する
   - [x] 4.7 配列についてもっと詳しく
   - [x] 4.8 ブロックについてもっと詳しく
   - [x] 4.9 範囲（Range）についてもっと詳しく
   - [x] 4.10 さまざまな繰り返し処理
   - [x] 4.11 繰り返し処理用の制御構造
   - [x] 4.12 この章のまとめ
- [x] 第5章  ハッシュやシンボルを理解する
   - [x] 5.1 イントロダクション
   - [x] 5.2 ハッシュ
   - [x] 5.3 シンボル
   - [x] 5.4 続・ハッシュについて
   - [x] 5.5 例題：長さの単位交換プログラムを作成する
   - [x] 5.6 ハッシュとキーワード引数についてもっと詳しく
   - [x] 5.7 シンボルについてもっと詳しく
   - [x] 5.8 この章のまとめ
- [x] 第6章  正規表現を理解する
   - [x] 6.1 イントロダクション
   - [x] 6.2 正規表現って何？
   - [x] 6.3 Ruby における正規表現オブジェクト
   - [x] 6.4 例題：Ruby のハッシュ記法を変換する
   - [x] 6.5 正規表現オブジェクトについてもっと詳しく
   - [x] 6.6 この章のまとめ
- [ ] 第7章  クラスの作成を理解する
   - [x] 7.1 イントロダクション
   - [x] 7.2 オブジェクト指向プログラミングの基礎知識
   - [x] 7.3 クラスの定義
   - [x] 7.4 例題：改札機プログラムの作成
   - [ ] 7.5 selfキーワード
   - [ ] 7.6 クラスの継承
   - [ ] 7.7 メソッドの可視性
   - [ ] 7.8 定数についてもっと詳しく
   - [ ] 7.9 さまざまな種類の変数
   - [ ] 7.10 クラス定義や Ruby の言語使用に関する高度な話題
   - [ ] 7.11 この章のまとめ
- [ ] 第8章  モジュールを理解する
   - [ ] 8.1 イントロダクション
   - [ ] 8.2 モジュールの概要
   - [ ] 8.3 モジュールを利用したメソッド定義（include と extend）
   - [ ] 8.4 例題：rainbowメソッドの作成
   - [ ] 8.5 モジュールを利用したメソッド定義についてもっと詳しく
   - [ ] 8.6 モジュールを利用した名前空間の作成
   - [ ] 8.7 関数や定数を提供するモジュールの作成
   - [ ] 8.8 状態を保持するモジュールの作成
   - [ ] 8.9 モジュールに関する高度な話題
   - [ ] 8.10 この章のまとめ
- [ ] 第9章  例外処理を理解する
   - [ ] 9.1 イントロダクション
   - [ ] 9.2 例外の捕捉
   - [ ] 9.3 意図的に例外を発生させる
   - [ ] 9.4 例外処理のベストプラクティス
   - [ ] 9.5 例題：正規表現チェッカープログラムの作成
   - [ ] 9.6 例外処理についてもっと詳しく
   - [ ] 9.7 この章のまとめ
- [ ] 第10章  yield と Proc を理解する
   - [ ] 10.1 イントロダクション
   - [ ] 10.2 ブロックを利用するメソッドの定義と yield
   - [ ] 10.3 Procオブジェクト
   - [ ] 10.4 例題：ワードシンセサイザーの作成
   - [ ] 10.5 Procオブジェクトについてもっと詳しく
   - [ ] 10.6 この章のまとめ
- [ ] 第11章  パターンマッチを理解する
   - [ ] 11.1 イントロダクション
   - [ ] 11.2 パターンマッチの基本
   - [ ] 11.3 パターンマッチの利用パターン
   - [ ] 11.4 例題：ログフォーマッターの作成
   - [ ] 11.5 パターンマッチについてもっと詳しく
   - [ ] 11.6 この章のまとめ
- [ ] 第12章  Ruby のデバッグ技法を身につける
   - [ ] 12.1 イントロダクション
   - [ ] 12.2 バックトレースの読み方
   - [ ] 12.3 よく発生する例外クラスとその原因
   - [ ] 12.4 プログラムの途中経過を確認する
   - [ ] 12.5 汎用的なトラブルシューティング方法
   - [ ] 12.6 この章のまとめ
- [ ] 第13章  Ruby に関するその他のトピック
   - [ ] 13.1 イントロダクション
   - [ ] 13.2 日付や時刻の扱い
   - [ ] 13.3 ファイルやディレクトリの扱い
   - [ ] 13.4 特定の形式のファイルを読み書きする
   - [ ] 13.5 環境変数や起動時引数の取得
   - [ ] 13.6 非推奨機能を使ったときに警告を出力する
   - [ ] 13.7 eval、バッククオートリテラル、sendメソッド
   - [ ] 13.8 Rake
   - [ ] 13.9 gem と Bundler
   - [ ] 13.10 Ruby における型情報の定義と型検査（RBS、TypeProf、Steep）
   - [ ] 13.11 「Rails の中の Ruby」と「素の Ruby」の違い
   - [ ] 13.12 この章のまとめ

</details>


------------


## 🧑🏻‍💻 本日の取り組み
### プラクティス『Ruby中級』
- 参考書籍：『プロを目指す人のためのRuby入門 <改訂2版>』を読み進める
  - 第7章  クラスの作成を理解する
    - 7.4 例題：改札機プログラムの作成


## 🎯 次回
### プラクティス『Ruby中級』
- 参考書籍：『プロを目指す人のためのRuby入門 <改訂2版>』を読み進める
  - 第7章  クラスの作成を理解する
    - 7.5 selfキーワード


------------


## 💡 本日の学び・気付き
### 7.4 例題：改札機プログラムの作成
改札機プログラムの実行例
```ruby
# 改札オブジェクトの作成
umeda = Gate.new(:umeda)
mikuni = Gate.new(:mikuni)

# 160円の切符を購入して梅田で乗車し、三国で降車する（NG）
ticket = Ticket.new(160)
umeda.enter(ticket)
mikuni.exit(ticket)

# 190円の切符を購入して梅田で乗車し、三国で降車する（OK）
ticket = Ticket.new(190)
umeda.enter(ticket)
mikuni.exit(ticket)
```

#### テストコードを準備する
作成した gate_test.rb ファイルに以下のコードを書く。
```ruby
require 'minitest/autorun'
require_relative '../lib/gate'

class GateTest < Minitest::GateTest
  def test_gate
    # とりあえずGateオブジェクトが作れることを確認する
    assert Gate.new
  end
end
```
作成した gate.rb ファイルに、Gateクラスを定義する。
```ruby
class Gate
end
```
テストを実行してパスすることを確認する。
```shell
~/ruby-book % ruby test/gate_test.rb
Run options: --seed 891

# Running:

.

Finished in 0.000902s, 1108.6475 runs/s, 1108.6475 assertions/s.

1 runs, 1 assertions, 0 failures, 0 errors, 0 skips
```

#### 必要なメソッドやクラスを仮実装する
テストコードを書く。
```ruby
require 'minitest/autorun'
require_relative '../lib/gate'

class GateTest < Minitest::Test
  def test_gate
    umeda = Gate.new(:umeda)
    juso = Gate.new(:juso)

    ticket = Ticket.new(160)
    umeda.enter(ticket)
    assert juso.exit(ticket)
  end
end
```
この状態でテストを実行すると当然失敗するが、手順としてはOK。
```shell
~/ruby-book % ruby test/gate_test.rb
Run options: --seed 20290

# Running:

E

Finished in 0.001195s, 836.8201 runs/s, 0.0000 assertions/s.

  1) Error:
GateTest#test_gate:
ArgumentError: wrong number of arguments (given 1, expected 0)
    test/gate_test.rb:6:in `initialize'
    test/gate_test.rb:6:in `new'
    test/gate_test.rb:6:in `test_gate'

1 runs, 0 assertions, 0 failures, 1 errors, 0 skips
```
実装を開始する。Gateクラスに initializeメソッドを定義し、引数として駅の名前を受け取れるようにする。受け取った駅の名前はあとで使えるようにインスタンス変数に格納しておく。
```ruby
class Gate
  def initialize(name)
    @name = name
  end
end
```
initializeメソッドを実装したため、テストを実行するとエラーの内容が変わる。
```shell
~/ruby-book % ruby test/gate_test.rb
Run options: --seed 49793

# Running:

E

Finished in 0.000935s, 1069.5188 runs/s, 0.0000 assertions/s.

  1) Error:
GateTest#test_gate:
NameError: uninitialized constant GateTest::Ticket
    test/gate_test.rb:9:in `test_gate'

1 runs, 0 assertions, 0 failures, 1 errors, 0 skip
```
`NameError: uninitialized constant GateTest::Ticket`は訳すと「GateTest::Ticket（GateTestクラス内の Ticket）という定数が初期化されていません」という意味になる。つまり、「Ticketクラスが見つかりません」という意味。Ruby では**クラス名も定数の1つ**なので、エラーメッセージも「定数が見つからない」という内容になる。

Ticketクラスを作成するために、ticket.rbファイルを作成し、以下の内容を書く。
```ruby
class Ticket
  def initialize(fare)
    @fare = fare
  end
end
```
- fare：（交通機関の）料金、運賃という意味。

さらに、gate_test.rb で ticket.rb を読み込む。
```ruby
require 'minitest/autorun'
require_relative '../lib/gate'
require_relative '../lib/ticket'

class GateTest < Minitest::Test
  def test_gate
    umeda = Gate.new(:umeda)
    juso = Gate.new(:juso)

    ticket = Ticket.new(160)
    umeda.enter(ticket)
    assert juso.exit(ticket)
  end
end
```
テストを再度実行。
```shell
~/ruby-book % ruby test/gate_test.rb
Run options: --seed 5957

# Running:

E

Finished in 0.001023s, 977.5171 runs/s, 0.0000 assertions/s.

  1) Error:
GateTest#test_gate:
NoMethodError: undefined method `enter' for an instance of Gate
    test/gate_test.rb:11:in `test_gate'

1 runs, 0 assertions, 0 failures, 1 errors, 0 skips
```
テストはパスしていないが、エラーメッセージが変化。「Gateクラスに enterメソッドが定義されていない」というエラーメッセージが表示されている。

enterメソッドを実装し、また exitメソッドも実装しておく。
```ruby
class Gate
  def initialize(name)
    @name = name
  end

  def enter(ticket)
  end

  def exit(ticket)
    true
  end
end
```
テストを実行。
```shell
~/ruby-book % ruby test/gate_test.rb
Run options: --seed 15634

# Running:

.

Finished in 0.000940s, 1063.8298 runs/s, 1063.8298 assertions/s.

1 runs, 1 assertions, 0 failures, 0 errors, 0 skips
```

#### 運賃が足りているかどうかを判別する
新しくテスト用のメソッドを定義し、そこに2つめのテストシナリオをコードとして表現する。
```ruby
require 'minitest/autorun'
require_relative '../lib/gate'
require_relative '../lib/ticket'

class GateTest < Minitest::Test
  def test_gate
    umeda = Gate.new(:umeda)
    juso = Gate.new(:juso)

    ticket = Ticket.new(160)
    umeda.enter(ticket)
    assert juso.exit(ticket)
  end

  def test_umeda_to_mikuni_when_fare_is_not_enough
    umeda = Gate.new(:umeda)
    mikuni = Gate.new(:mikuni)

    ticket = Ticket.new(160)
    umeda.enter(ticket)
    refute mikuni.exit(ticket)
  end
end
```
テストを実行。
```shell
~/ruby-book % ruby test/gate_test.rb
Run options: --seed 9041

# Running:

F.

Finished in 0.000927s, 2157.4973 runs/s, 2157.4973 assertions/s.

  1) Failure:
GateTest#test_umeda_to_mikuni_when_fare_is_not_enough [test/gate_test.rb:21]:
Expected true to not be truthy.

2 runs, 2 assertions, 1 failures, 0 errors, 0 skips
```
Gateクラスの enterメソッドを実装。ここでは Ticketクラスの stampメソッドを呼び出し、自分の駅名を渡す。
```ruby
class Gate
  def initialize(name)
    @name = name
  end

  def enter(ticket)
    ticket.stamp(@name)
  end

  def exit(ticket)
    true
  end
end
```
Ticketクラスにも stampメソッドが必要。@stamped_at というインスタンス変数に駅名を格納しておく。
```ruby
class Ticket
  def initialize(fare)
    @fare = fare
  end

  def stamp(name)
    @stamped_at = name
  end
end
```
運賃（fare）と乗車駅（stamped_at）が外部から取得できるようにゲッターメソッドを追加する。
```ruby
class Ticket
  attr_reader :fare, :stamped_at
  
  def initialize(fare)
    @fare = fare
  end

  def stamp(name)
    @stamped_at = name
  end
end
```
Gateクラスの exitメソッドを実装する。ここでは calc_fare というメソッドを定義する。
```ruby
class Gate
  STATIONS = [:umeda, :juso, :mikuni]
  FARES = [160, 190]

  def initialize(name)
    @name = name
  end

  def enter(ticket)
    ticket.stamp(@name)
  end

  def exit(ticket)
    true
  end

  def calc_fare(ticket)
    from = STATIONS.index(ticket.stamped_at)
    to = STATIONS.index(@name)
    distance = to - from
    FARES[distance - 1]
  end
end
```
- indexメソッド：配列の中から引数に合致する要素の添え字を取得するメソッド。


適切な運賃と切符の購入額を比較し、足りているか否かを戻り値として返すようにする。
```ruby
class Gate
  STATIONS = [:umeda, :juso, :mikuni]
  FARES = [160, 190]

  def initialize(name)
    @name = name
  end

  def enter(ticket)
    ticket.stamp(@name)
  end

  def exit(ticket)
    fare = calc_fare(ticket)
    fare <= ticket.fare
  end

  def calc_fare(ticket)
    from = STATIONS.index(ticket.stamped_at)
    to = STATIONS.index(@name)
    distance = to - from
    FARES[distance - 1]
  end
end
```
パスできているか確認。
```shell
~/ruby-book % ruby test/gate_test.rb
Run options: --seed 7793

# Running:

..

Finished in 0.000973s, 2055.4984 runs/s, 2055.4984 assertions/s.

2 runs, 2 assertions, 0 failures, 0 errors, 0 skips
```

#### テストコードのリファクタリング
テストメソッドの名前を修正。test_gateメソッドを以下のように変更。
```ruby
class GateTest < Minitest::Test
  def test_umeda_to_juso
```
Gateオブジェクトの作成を共通化する。
```ruby
require 'minitest/autorun'
require_relative '../lib/gate'
require_relative '../lib/ticket'

class GateTest < Minitest::Test
  # テストメソッドが実行される前にこのメソッドが毎回呼ばれる
  def setup
    @umeda = Gate.new(:umeda)
    @juso = Gate.new(:juso)
    @mikuni = Gate.new(:mikuni)
  end

  def test_umeda_to_juso
    ticket = Ticket.new(160)
    @umeda.enter(ticket)
    assert @juso.exit(ticket)
  end

  def test_umeda_to_mikuni_when_fare_is_not_enough
    ticket = Ticket.new(160)
    @umeda.enter(ticket)
    refute @mikuni.exit(ticket)
  end
end
```
テストを実行。
```shell
~/ruby-book % ruby test/gate_test.rb
Run options: --seed 36298

# Running:

..

Finished in 0.000878s, 2277.9043 runs/s, 2277.9043 assertions/s.

2 runs, 2 assertions, 0 failures, 0 errors, 0 skips
```

#### 残りのテストケースをテストする
```ruby
require 'minitest/autorun'
require_relative '../lib/gate'
require_relative '../lib/ticket'

class GateTest < Minitest::Test
  # テストメソッドが実行される前にこのメソッドが毎回呼ばれる
  def setup
    @umeda = Gate.new(:umeda)
    @juso = Gate.new(:juso)
    @mikuni = Gate.new(:mikuni)
  end

  def test_umeda_to_juso
    ticket = Ticket.new(160)
    @umeda.enter(ticket)
    assert @juso.exit(ticket)
  end

  def test_umeda_to_mikuni_when_fare_is_not_enough
    ticket = Ticket.new(160)
    @umeda.enter(ticket)
    refute @mikuni.exit(ticket)
  end

  def test_umeda_to_mikuni_when_fare_is_enough
    ticket = Ticket.new(190)
    @umeda.enter(ticket)
    assert @mikuni.exit(ticket)
  end

  def test_juso_to_mikuni
    ticket = Ticket.new(160)
    @juso.enter(ticket)
    assert @mikuni.exit(ticket)
  end
end
```
テストを実行する。
```shell
~/ruby-book % ruby test/gate_test.rb
Run options: --seed 9394

# Running:

....

Finished in 0.001155s, 3463.2034 runs/s, 3463.2034 assertions/s.

4 runs, 4 assertions, 0 failures, 0 errors, 0 skips
```


-------------


## ✍🏻 感想
### 🤔 む、難しい
今日は、例題を基にプログラム本体の読み込み、テストコード作成、テストの実行を行いましたが、正直な感想は「難しい」です。「こういう感じでコードを書いて、こうやってテストを実行していくんだな」と、手を動かしながら考えていました。

チェリー本の読み方のコツにもありましたが、「**しんどくなってきたら頭の中にインデックスを作る読書スタイル**」にしっかりとスイッチングしながら進めていきます。

------------


### ⏰ 学習時間
- Today:&nbsp;&nbsp;&nbsp; 2 hours 04 min
- Total: 946 hours 21 min
