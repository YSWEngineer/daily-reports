# 2026/02/18(水)
## 📚 プラクティス『🛠️💻 lsコマンドを作る4』

<details><summary>🎯 学習の狙い</summary>

- 標準出力について学ぶ
- 標準ライブラリの使い方を学ぶ
- Enumeratorには、each以外にも便利なメソッドがあることを学ぶ
- RailsじゃないRubyプログラミングを学ぶ
- メソッド分割を学ぶ
- わかりやすい変数名・メソッド名を学ぶ
- 大きな問題を分割する力を学ぶ
</details>

<details><summary>📌 要件 ※ 随時、追加・変更あり</summary>

- [x] `-l`オプションが指定された場合は、各ファイルについて「詳細情報（long format）」を一行ずつ表示すること
- [x] `-l`オプションが指定されていない場合は、これまで通りファイル名のみを表示すること
- [x] 表示する詳細情報は、以下の内容を含ませること
  - [x] ファイルタイプ
  - [x] ファイルモード
  - [x] リンク数
  - [x] 所有者
  - [x] 所有グループ
  - [x] サイズ
  - [x] タイムスタンプ（更新日時）
  - [x] ファイル名もしくはディレクトリ名
- [x] `gem`は使わずに Ruby の標準ライブラリだけで作ること
- [ ] `rubocop-fjord`でコードをチェックし、全てパスさせること
- [ ] 完成したコードは GitHub の Pull Request として提出すること

</details>

<details><summary>📍 処理の流れ ※ 随時、追加・変更あり</summary>

1. コマンドライン引数から`-l`オプションの有無を判定する

2. 対象のディレクトリのファイル一覧を配列として取得する

3. `-l`オプションが指定されていない場合 → これまで通り、ファイル名の配列をそのまま表示する

4. `-l`オプションが指定されている場合 → ①配列の各要素（各ファイル）について詳細情報を取得する / ②取得した複数の属性を一行の文字列に整形する

5. 整形済みの各行を上から順に標準出力へ表示させる
</details>

<details><summary> 🧩 タスクばらし ※ 随時、追加・変更あり</summary>

- [x] タスク1：コマンドライン引数を解析し、`-l`オプションの有無を取得する
- [x] タスク2：対象のディレクトリのファイル一覧を配列として取得する
- [x] タスク3：「一つのファイルについて、どんな情報が取れるのか」を調べる
  - [x] ファイルタイプ
  - [x] ファイルモード
  - [x] リンク数
  - [x] 所有者
  - [x] 所有グループ
  - [x] サイズ
  - [x] タイムスタンプ（更新日時）
  - [x] ファイル名
- [x] タスク4：取得した「詳細情報（各属性）」を表示する
  - [x] まずはバラバラに値を取り出せるようにする
- [x] タスク5：複数の属性を整形して表示する
  - [x] 横に並べて一行にする
- [x] タスク6：タスク3〜5で行った処理を全てのファイルに対して適用する
  - [x] まずは1ファイルで成功させる
  - [x] 次に`each`で各ファイルに処理を適用させる
- [x] タスク7：`-l`オプションが指定されていないときに、`ls`コマンドと同じ挙動になることを確認する
- [ ] タスク8：rubocop-fjord に通す
- [ ] タスク9：提出
  - [ ] 作成した lsコマンドを Pull Request として提出
  - [ ] 提出物に、`ls -l`コマンドの実行結果と、OS標準（macなど自分の使ってるOS）の`ls -l`コマンドの実行結果のスクリーンショットを併記して貼る
  - [ ] rubocop-fjord のチェックが全てパスした画面をスクショして添付
</details>


---


## 🧑🏻‍💻 本日の取り組み
### 📚 プラクティス『🛠️💻 lsコマンドを作る4』 
- タイムスタンプを右寄せに整形する
- ファイル名を表示する
- `ls -l`コマンドを完成させる


---


## ⏭️ 次回
### 📚 プラクティス『lsコマンドを作る4』
- `rubocop-fjord`でコードチェックを行う
- Pull Request 作成 & 提出
- メンターさんに1回目の課題提出


---


## 💡 本日の学び・気付き
### タイムスタンプ（mtime）を右寄せにする
#### 表示したい形式
まず、タイムスタンプの表示形式は文字列の長さがバラバラでも整列させるために右寄せを行う。
```
Feb 10 20:23
Jan 22 05:38
Feb  2 18:39
```

#### 作成したコード
```ruby
files = Dir.children(".")

# 1. 各ファイルの整形済みmtimeを全て集める
mtimes = files.map do |path| 
  File.stat(path).mtime.strftime("%b %e %H:%M")
end

# 2. 最大値を調べる
width = mtimes.map(&:length).max

# 3. 右寄せして表示
files.each_with_index do |path, i|
  puts mtimes[i].rjust(width)
end
```
```ruby
# ファイル一覧を取得
files = Dir.children(".")
```
- カレントディレクトリのファイル名を取得する
- このあと、この配列を元に処理を行う

```ruby
# 各ファイルのmtimeを「文字列」として取り出す
mtimes = files.map do |path|
  File.stat(path).mtime.strftime("%b %e %H:%M")
end
```
`files.map`
- 配列の要素を1つずつ変換するメソッド
- `map`メソッドの結果は「新しい配列」になる

`Files.stat(path)`
- そのファイルの`Stat`（メタ情報）を取得する

`.mtime`
- タイムスタンプ（更新日時）を返す

`.strftime("%b %e %H:%M")`
- 整形された文字列に変換

```ruby
# 最大幅を調べる
width = mtimes.map(&:length).max
```
`mtimes.map(&:length)`
- それぞれの文字列の長さを取得する

`.max`
- その中の最大値を取る

```ruby
# 右寄せして表示
files.each_with_index do |path, i|
  puts mtimes[i].rjust(width)
end
```
`each_with_index`
- `files`の各要素を順番に取り出しつつ、その時の**インデックス**`i`も一緒に受け取る

`mtimes[i]`
- 先程作成した`mtimes`の中から対応するファイルのmtimeの文字列を取り出す

`.rjust(width)`
- 右寄せするメソッド
- `width`の分の幅で右寄せを行う

#### 実行結果
```
~/stat_check % ruby stat_mtime_check.rb
Jan 22 05:38
Feb 10 17:33
Feb 14 13:32
Jan 22 05:38
Feb 14 14:58
Feb 12 20:38
Jan 22 05:36
Feb 10 17:33
Jan 22 05:38
Feb 10 20:23
Jan 22 05:38
Feb  2 18:39
Feb 11 15:11
Feb 18 14:16
Feb 18 14:12
```
ズレがなく表示されている！

#### まとめ
タイムスタンプについても
- 多くの値を「最初に全て集めて」
- 最大幅を「先に計算して」
- 最終的に「`rjust`（右寄せ）」にできる

これは`uid`、`gid`、`size`のような右寄せ処理にも共通しているのが分かる。


---


### ファイル名を表示する
#### File.basenameの意味
ざっくり言うと、`File.basename`はパスの文字列の最後の部分だけを取り出してくれる。

例：パスの最後の部分を返す
```ruby
File.basename("/home/user/file.txt")
#=> file.txt
```
最後のスラッシュ`/`よりあとの部分だけを返すので、`"/home/user/file.txt"`から`file.txt`を取り出してくれる。

#### 無理に使う必要は......
わざわざ`basename`を使用しなくても、`path`を表示させればよいのでは？と考える。
```ruby
# ファイル名を表示する
files = Dir.children(".")

files.each do |path|
  puts path
end

# 実行結果
~/stat_check % ruby stat_filename_check.rb
file.txt
nlink_file_link.txt
stat_group_check.rb
link_to_file
stat_size_check.rb
stat_owner_check.rb
stat_type_check.rb
stat_filename_check.rb
nlink_file.txt
new_link
dir_for_nlink
test_dir
stat_perm_check.rb
stat_link_check.rb
stat_mtime_check.rb
.idea
```
これでいいのでは🤔

#### まとめ
- パス名を返してくれる`basename`メソッドがある
- しかし、今回の場合はパス名をそのまま表示させるだけなので無理に使用する必要はないような気がする

#### 🔗 参考リンク
[singleton method File.basename](https://docs.ruby-lang.org/ja/latest/method/File/s/basename.html?utm_source=chatgpt.com)


---


### メタ情報達を横に一行で表示する
<details><summary>⚠️ ネタバレに注意 </summary>

```ruby
require 'etc'

def permission_string(mode)
  perm = mode.to_s(8)[-3, 3]
  table = {
    '0' => '---',
    '1' => '--x',
    '2' => '-w-',
    '3' => '-wx',
    '4' => 'r--',
    '5' => 'r-x',
    '6' => 'rw-',
    '7' => 'rwx',
  }
  perm.chars.map { |n| table[n] }.join
end

files = Dir.children(".")

stats = files.map { |path| File.lstat(path) }

nlinks = stats.map(&:nlink)
sizes = stats.map(&:size)
mtimes = stats.map { |st| st.mtime.strftime("%b %e %H:%M") }

nlink_width = nlinks.map { |n| n.to_s.length }.max
size_width = sizes.map { |s| s.to_s.length }.max
mtime_width = mtimes.map { |t| t.length }.max


files.each do |path|
  stat = File.stat(path)

  type =
    if stat.symlink?
      'l'
    elsif stat.directory?
      'd'
    else
      '-'
    end

  perm = permission_string(stat.mode)

  nlink = stat.nlink

  owner = Etc.getpwuid(stat.uid).name
  group = Etc.getgrgid(stat.gid).name

  size = stat.size

  mtime_str = stat.mtime.strftime("%b %e %H:%M")

  mode_str = "#{type}#{perm}"

  line = [
    mode_str,
    nlink.to_s.rjust(nlink_width),
    owner,
    group,
    size.to_s.rjust(size_width),
    mtime_str.rjust(mtime_width),
    path
  ].join(" ")

  puts line
end
```
#### 1. ライブラリを読み込む
```ruby
require 'etc'
```
`Etc`はユーザー名・グループ名を取得するための標準ライブラリで`stat.uid` → `yoshiwo`のように名前に変換するために使用する。

#### 2. permission stringメソッド
```ruby
def permission_string(mode)
```
`mode`はファイルのモード（種類 + パーミッションを含む整数）。
例：`33188`（10進数）。この数字の中に`-rw-r--r--`の情報が含まれている。

##### 2-1. modeを8進数に変換して、末尾3桁を取得する
```ruby
perm = mode.to_s(8)[-3, 3]
```
`mode.to_s(8)`
→ `mode`を8進数の文字列に変換（例：`33188` → `100644`）

`[-3, 3]`
→ 文字列の後ろから3文字を取得する。
→ `644`のような`rwx`を意味する部分だけを抜き出す。
→ つまり、`perm`は`"644"`という文字列になる。

##### 2-2. 8進数のパーミッション→文字列"rwx"に変換するテーブル
```ruby
table = {
  '0' => '---',
  '1' => '--x',
  '2' => '-w-',
  '3' => '-wx',
  '4' => 'r--',
  '5' => 'r-x',
  '6' => 'rw-',
  '7' => 'rwx',
}
```
→ 取得した3桁の数字を変換するための対応表。
→ 例：`'6' → 'rw-'`

##### 2-3. 各桁を変換して結合する
```ruby
perm.chars.map { |n| table[n] }.join
```
→ `"644"`→`["6", "4", "4"]`→`["rw-", "r--", "r--"]`→`"rw-r--r--"`

#### 3. ファイル一覧取得
```ruby
files = Dir.children(".")
```
→ 今いるディレクトリのファイル名を配列で取得する。

#### 4. 各ファイルのstatを取得
```ruby
stats = files.map { |path| File.lstat(path) }
```
→ `File.lstat`はシンボリックリンクをリンクとして扱う`stat`。
→ `stats`は`stat`オブジェクトの配列。

#### 5. 列幅計算のために必要な情報を抽出
##### 5-1. link数
```ruby
nlinks = stats.map(&:nlink)
```
→ `:nlink`は「ハードリンク数」

##### 5-2. サイズ
```ruby
sizes = stats.map(&:size)
```

##### 5-3. 更新日時
```ruby
mtimes = stats.map { |st| st.mtime.strftime("%b %e %H:%M") }
```
ここで`Feb 10 17:33`のような文字列に変換。

#### 6. 列幅の計算
右揃えをするために、取得した全てのファイルの中で最も長いものを取得する。
```ruby
nlink_width = nlinks.map { |n| n.to_s.length }.max
size_width = sizes.map { |s| s.to_s.length }.max
mtime_width = mtimes.map { |t| t.length }.max
```
例えば、
→ `nlink`が`[1, 12, 3]`なら、最長は`"12"`の**2文字**。
→ `size`が`[30, 1040, 8]`なら、`"1040"`の**4文字**。

#### 7. 個別のメタ情報を得る
```ruby
stat = File.stat(path)
```

#### 8. 文字の判定
```ruby
type =
  if stat.symlink?
    'l'
  elsif stat.directory?
    'd'
  else
    '-'
  end
```

#### 9. パーミッションの文字列の生成
```ruby
perm = permisson_string(stat.mode)
```
→ 先程の`"rw-r--r--"`を取得。

#### 10. ハードリンク数
```ruby
nlink = stat.nlink
```

#### 11. 所有者・所有グループ
```ruby
owner = Etc.getpwuid(stat.uid).name
group = Etc.getgrgid(stat.gid).name
```

#### 12. サイズ
```ruby
size = stat.size
```

#### 13. タイムスタンプ
```ruby
mtime_str = stat.mtime.strftime("%b %e %H:%M")
```

#### 14. ファイルタイプ・ファイルモードの文字列を連結
```ruby
mode_str = "#{type}#{perm}"
```
→ 例：`-rw-r--r--`

#### 15. 各要素を配列にまとめ、整形する
```ruby
line = [
  mode_str,
  nlink.to_s.rjust(nlink_width),
  owner,
  group,
  size.to_s.rjust(size_width),
  mtime_str.rjust(mtime_width),
  path
].join(" ")
```
→ `rjust(nlink_width)`：リンク数を右揃え。
→ `rjust(size_width)`：サイズを右揃え。
→ `rjust(mtime_width)`：タイムスタンプを右揃え。

#### 16. 表示
```ruby
puts line
```

#### 実行結果
```
~/stat_check % ruby ls_l_all_parts.rb
-rw-r--r-- 2 yoshiwo staff    0 Jan 22 05:38 file.txt
-rw-r--r-- 2 yoshiwo staff    6 Feb 10 17:33 nlink_file_link.txt
-rw-r--r-- 1 yoshiwo staff  241 Feb 14 13:32 stat_group_check.rb
-rw-r--r-- 2 yoshiwo staff    0 Jan 22 05:38 link_to_file
-rw-r--r-- 1 yoshiwo staff  256 Feb 14 14:58 stat_size_check.rb
-rw-r--r-- 1 yoshiwo staff  313 Feb 12 20:38 stat_owner_check.rb
-rw-r--r-- 1 yoshiwo staff  282 Feb 18 16:27 stat_type_check.rb
-rw-r--r-- 1 yoshiwo staff  109 Feb 18 15:07 stat_filename_check.rb
-rw-r--r-- 2 yoshiwo staff    6 Feb 10 17:33 nlink_file.txt
-rw-r--r-- 2 yoshiwo staff    0 Jan 22 05:38 new_link
drwxr-xr-x 3 yoshiwo staff   96 Feb 10 20:23 dir_for_nlink
drwxr-xr-x 2 yoshiwo staff   64 Jan 22 05:38 test_dir
-rw-r--r-- 1 yoshiwo staff  495 Feb  2 18:39 stat_perm_check.rb
-rw-r--r-- 1 yoshiwo staff  404 Feb 11 15:11 stat_link_check.rb
-rw-r--r-- 1 yoshiwo staff  548 Feb 18 14:16 stat_mtime_check.rb
-rw-r--r-- 1 yoshiwo staff 1193 Feb 18 17:19 ls_l_all_parts.rb
drwxr-xr-x 7 yoshiwo staff  224 Feb 18 17:16 .idea
```
`ls -l`コマンド風の表示ができている......はず！

#### まとめ

→ **各ファイルの`stat`情報を一度に全て読み込む。**
→ **列幅の最大値を計算。**
→ **右揃え（`rjust`）で整形。**
→ **一行の文字列を`join(" ")`で結合。**
→ **これまでのプラクティスを通して学んだ知識が集結されている印象。**
</details>


---


## ✍🏻 感想
### 🏋🏻 メタ情報達を一つに 
`ls -l`コマンドで表示される各要素を一行に表示することができました（めっちゃ嬉しいけど、疲れて喜ぶエネルギーがない）。疲労困憊 & 夕食の支度のため、`rubocop-fjord`でのコードチェックは次回へ🫠


---


### ⏰ 学習時間
- Today:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4 hours 49 min
- Total: 1497 hours 11 min
