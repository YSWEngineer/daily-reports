# 2026/02/19(木)
## 📚 プラクティス『🛠️💻 lsコマンドを作る4』

<details><summary>🎯 学習の狙い</summary>

- 標準出力について学ぶ
- 標準ライブラリの使い方を学ぶ
- Enumeratorには、each以外にも便利なメソッドがあることを学ぶ
- RailsじゃないRubyプログラミングを学ぶ
- メソッド分割を学ぶ
- わかりやすい変数名・メソッド名を学ぶ
- 大きな問題を分割する力を学ぶ
</details>

<details><summary>📌 要件 ※ 随時、追加・変更あり</summary>

- [x] `-l`オプションが指定された場合は、各ファイルについて「詳細情報（long format）」を一行ずつ表示すること
- [x] `-l`オプションが指定されていない場合は、これまで通りファイル名のみを表示すること
- [x] 表示する詳細情報は、以下の内容を含ませること
  - [x] total（ブロック数）
  - [x] ファイルタイプ
  - [x] ファイルモード
  - [x] リンク数
  - [x] 所有者
  - [x] 所有グループ
  - [x] サイズ
  - [x] タイムスタンプ（更新日時）
  - [x] ファイル名もしくはディレクトリ名
- [x] `@`のMacの拡張属性の実装は必須ではない
- [x] `gem`は使わずに Ruby の標準ライブラリだけで作ること
- [x] `rubocop-fjord`でコードをチェックし、全てパスさせること
- [x] 完成したコードは GitHub の Pull Request として提出すること

</details>

<details><summary>📍 処理の流れ ※ 随時、追加・変更あり</summary>

1. コマンドライン引数から`-l`オプションの有無を判定する

2. 対象のディレクトリのファイル一覧を配列として取得する

3. `-l`オプションが指定されていない場合 → これまで通り、ファイル名の配列をそのまま表示する

4. `-l`オプションが指定されている場合 → ①配列の各要素（各ファイル）について詳細情報を取得する / ②取得した複数の属性を一行の文字列に整形する

5. 整形済みの各行を上から順に標準出力へ表示させる
</details>

<details><summary> 🧩 タスクばらし ※ 随時、追加・変更あり</summary>

- [x] タスク1：コマンドライン引数を解析し、`-l`オプションの有無を取得する
- [x] タスク2：対象のディレクトリのファイル一覧を配列として取得する
- [x] タスク3：「一つのファイルについて、どんな情報が取れるのか」を調べる
  - [x] total（ブロック数）
  - [x] ファイルタイプ
  - [x] ファイルモード
  - [x] リンク数
  - [x] 所有者
  - [x] 所有グループ
  - [x] サイズ
  - [x] タイムスタンプ（更新日時）
  - [x] ファイル名
- [x] タスク4：取得した「詳細情報（各属性）」を表示する
  - [x] まずはバラバラに値を取り出せるようにする
- [x] タスク5：複数の属性を整形して表示する
  - [x] 横に並べて一行にする
- [x] タスク6：タスク3〜5で行った処理を全てのファイルに対して適用する
  - [x] まずは1ファイルで成功させる
  - [x] 次に`each`で各ファイルに処理を適用させる
- [x] タスク7：`-l`オプションが指定されていないときに、`ls`コマンドと同じ挙動になることを確認する
- [x] タスク8：rubocop-fjord に通す
- [x] タスク9：提出
  - [x] 作成した lsコマンドを Pull Request として提出
  - [x] 提出物に、`ls -l`コマンドの実行結果と、OS標準（macなど自分の使ってるOS）の`ls -l`コマンドの実行結果のスクリーンショットを併記して貼る
  - [x] rubocop-fjord のチェックが全てパスした画面をスクショして添付
</details>


---


## 🧑🏻‍💻 本日の取り組み
### 📚 プラクティス『🛠️💻 lsコマンドを作る4』 
- total（ブロック数）を実装
- `rubocop-fjord`でコードチェックを行う
- Pull Request 作成 & 提出
- メンターさんに1回目の課題提出


---


## ⏭️ 次回
- 来週開催予定の『アジャイルサムライ輪読会』に向けて、書籍『いちばんやさしいアジャイル開発の教本』『SCRUM BOOT CAMP THE BOOK』を読む


---


## 💡 本日の学び・気付き
### total（ブロック数）
#### 1. ブロック数：「ファイルを保存するときに使われる最小単位の塊の数」
- OS は、ファイルを保存するときにあらかじめ決まった大きさの箱（=ブロック）に分けて保存する。

#### 2. totalは、ブロック数の合計
`ls -l`コマンドを実行したときに一番上に表示される`total`は、**このディレクトリ内のファイルが使っているブロック数の合計**である。

#### 3. totalを表示する処理の書き方
Ruby では、以下を使用する。
- `File::Stat`クラス
- `stat.blocks`メソッド（そのファイルが使っているブロック数）

例）
```ruby
def print_total(files)
  stats = files.map { |f| File::Stat.new(f) }
  total_blocks = stats.sum(&:blocks)
  puts "total #{total_blocks}"
end
```
- `files`（ファイル名の配列）を`Stat`に変換 → `File::Stat.new(f)`で一つのファイルのメタ情報を取得する
- `blocks`メソッドでそのファイルのブロック数を取得する
- `sum(&blocks)`でブロック数を全て足す → `total`に必要な数値
- `puts "total #{total_blocks}"` → `ls -l`コマンドと同じ形式で表示する

#### まとめ
##### ブロック数とは？
- ファイルシステムがファイルを保存するための「一定サイズの箱」
- ファイルは内容が満タンでなくても1ブロックまるまる使用する

##### ls -lのtotalとは？
- ディレクトリ内の全てのファイルが消費しているブロック数の合計

##### Rubyでtotalを表示する基本コード
```ruby
files = Dir.glob('*')
stats = files.map { |f| File::Stat.new(f) }
total = stats.sum(&:blocks)
puts "total #{total}"

# 実行結果
~/stat_check % ruby stat_total_check.rb
total 112
```

### rubocop-fjordでコードチェックを行う
#### コードチェック時のコード内容 
<details><summary>⚠️ ネタバレに注意 </summary>

```ruby
# frozen_string_literal: true

# !/usr/bin/env ruby
require 'optparse'

show_hidden = false
reverse = false
show_long = false

opt = OptionParser.new
opt.on('-a') { show_hidden = true }
opt.on('-r') { reverse = true }
opt.on('-l') { show_long = true }

opt.parse!(ARGV)

require 'etc'

def permission_string(mode)
  perm = mode.to_s(8)[-3, 3]
  table = {
    '0' => '---',
    '1' => '--x',
    '2' => '-w-',
    '3' => '-wx',
    '4' => 'r--',
    '5' => 'r-x',
    '6' => 'rw-',
    '7' => 'rwx'
  }
  perm.chars.map { |n| table[n] }.join
end

files = Dir.children(".")

unless show_long
  files.each { |f| puts f}
  exit
end

stats = files.map { |path| File.lstat(path) }

nlinks = stats.map(&:nlink)
sizes = stats.map(&:size)
mtimes = stats.map { |st| st.mtime.strftime("%b %e %H:%M") }

nlink_width = nlinks.map { |n| n.to_s.length }.max
size_width = sizes.map { |s| s.to_s.length }.max
mtime_width = mtimes.map { |t| t.length }.max

files.each do |path|
  stat = File.stat(path)

  type =
    if stat.symlink?
      'l'
    elsif stat.directory?
      'd'
    else
      '-'
    end

  perm = permission_string(stat.mode)

  nlink = stat.nlink
  owner = Etc.getpwuid(stat.uid).name
  group = Etc.getgrgid(stat.gid).name
  size = stat.size
  mtime_str = stat.mtime.strftime("%b %e %H:%M")
  mode_str = "#{type}#{perm}"

  line = [
    mode_str,
    nlink.to_s.rjust(nlink_width),
    owner,
    group,
    size.to_s.rjust(size_width),
    mtime_str.rjust(mtime_width),
    path
  ].join(" ")

  puts line
end
```
#### rubocopの結果
```shell
~/ls_test % rubocop 
Inspecting 1 file
C

Offenses:

ls.rb:19:1: C: Metrics/MethodLength: Method has too many lines. [12/10]
def permission_string(mode) ...
^^^^^^^^^^^^^^^^^^^^^^^^^^^
ls.rb:34:22: C: [Correctable] Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.
files = Dir.children(".")
                     ^^^
ls.rb:37:26: C: [Correctable] Layout/SpaceInsideBlockBraces: Space missing inside }.
  files.each { |f| puts f}
                         ^
ls.rb:45:45: C: [Correctable] Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.
mtimes = stats.map { |st| st.mtime.strftime("%b %e %H:%M") }
                                            ^^^^^^^^^^^^^
ls.rb:49:26: C: [Correctable] Style/SymbolProc: Pass &:length as an argument to map instead of a block.
mtime_width = mtimes.map { |t| t.length }.max
                         ^^^^^^^^^^^^^^^^
ls.rb:51:1: C: Metrics/BlockLength: Block has too many lines. [26/25]
files.each do |path| ...
^^^^^^^^^^^^^^^^^^^^
ls.rb:69:35: C: [Correctable] Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.
  mtime_str = stat.mtime.strftime("%b %e %H:%M")
                                  ^^^^^^^^^^^^^
ls.rb:80:10: C: [Correctable] Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.
  ].join(" ")
         ^^^
ls.rb:84:1: C: [Correctable] Layout/TrailingEmptyLines: 1 trailing blank lines detected.

1 file inspected, 9 offenses detected, 7 offenses autocorrectable
```
#### rubocopのメッセージを噛み砕く
```shell
ls.rb:19:1: C: Metrics/MethodLength: Method has too many lines. [12/10]
def permission_string(mode) ...
^^^^^^^^^^^^^^^^^^^^^^^^^^^
```
意味：`pemission_string`メソッドの行が長すぎる。上限は`10`なのに`12`もある。

```shell
ls.rb:34:22: C: [Correctable] Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.
files = Dir.children(".")
                     ^^^
```
意味：ダブルクォーテーション`"`ではなく、シングルクォーテーション`'`が好ましい。
```shell
ls.rb:37:26: C: [Correctable] Layout/SpaceInsideBlockBraces: Space missing inside }.
  files.each { |f| puts f}
                         ^
```
意味：ブロックの中にスペースがない（該当箇所にスペースを入れる）。
```shell
ls.rb:45:45: C: [Correctable] Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.
mtimes = stats.map { |st| st.mtime.strftime("%b %e %H:%M") }
                                            ^^^^^^^^^^^^^
```
意味：ダブルクォーテーション`"`ではなく、シングルクォーテーション`'`が好ましい。
```shell
ls.rb:49:26: C: [Correctable] Style/SymbolProc: Pass &:length as an argument to map instead of a block.
mtime_width = mtimes.map { |t| t.length }.max
                         ^^^^^^^^^^^^^^^^
```
意味：SymbolProc（シンボルプロック）で書くことができる。
```shell
ls.rb:51:1: C: Metrics/BlockLength: Block has too many lines. [26/25]
files.each do |path| ...
^^^^^^^^^^^^^^^^^^^^
```
意味：ブロックが長すぎる。上限は`25`なのに、`26`もある。
```shell
ls.rb:69:35: C: [Correctable] Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.
  mtime_str = stat.mtime.strftime("%b %e %H:%M")
                                  ^^^^^^^^^^^^^
```
意味：ダブルクォーテーション`"`ではなく、シングルクォーテーション`'`が好ましい。
```shell
ls.rb:80:10: C: [Correctable] Style/StringLiterals: Prefer single-quoted strings when you don't need string interpolation or special symbols.
  ].join(" ")
         ^^^
```
意味：ダブルクォーテーション`"`ではなく、シングルクォーテーション`'`が好ましい。
```shell
ls.rb:84:1: C: [Correctable] Layout/TrailingEmptyLines: 1 trailing blank lines detected.
```
意味：空行が1つ見つかった（余分な空行を1つ削除する）。

#### total（ブロック数）を追加し、rubocopをパスしたコード
```ruby
# frozen_string_literal: true

# !/usr/bin/env ruby
require 'optparse'
require 'etc'

show_hidden = false
reverse = false
show_long = false

opt = OptionParser.new
opt.on('-a') { show_hidden = true }
opt.on('-r') { reverse = true }
opt.on('-l') { show_long = true }
opt.parse!(ARGV)

def permission_string(mode)
  perm = mode.to_s(8)[-3, 3]
  table = {
    '0' => '---', '1' => '--x', '2' => '-w-', '3' => '--x',
    '4' => '--x', '5' => 'r-x', '6' => 'rw-', '7' => 'rwx'
  }
  perm.chars.map { |n| table[n] }.join
end

files = Dir.children('.')
files.sort!
files.reverse! if reverse
files.reject! { |f| f.start_with?('_') } unless show_hidden

unless show_long
  files.each { |f| puts f }
  exit
end

stats = files.map { |path| File.lstat(path) }

total_blocks = stats.sum(&:blocks)
puts "total #{total_blocks}"

nlink_width = stats.map { |s| s.nlink.to_s.length }.max
size_width = stats.map { |s| s.size.to_s.length }.max
mtime_width = stats.map { |s| s.mtime.strftime('%b %e %H:%M').length }.max

files.each do |path|
  stat = File.stat(path)

  type =
    if stat.symlink?
      'l'
    elsif stat.directory?
      'd'
    else
      '-'
    end

  perm = permission_string(stat.mode)

  nlink = stat.nlink
  owner = Etc.getpwuid(stat.uid).name
  group = Etc.getgrgid(stat.gid).name
  size = stat.size
  mtime_str = stat.mtime.strftime('%b %e %H:%M')

  line = [
    "#{type}#{perm}",
    nlink.to_s.rjust(nlink_width),
    owner,
    group,
    size.to_s.rjust(size_width),
    mtime_str.rjust(mtime_width),
    path
  ].join(' ')

  puts line
end

```

#### 実行結果
```
~/stat_check % ruby ~/ls_test/ls.rb -l
total 112
drwxr-xr-x 7 yoshiwo staff  224 Feb 19 18:45 .idea
-rw---x--x 1 yoshiwo staff   97 Feb 19 15:37 Gemfile
-rw---x--x 1 yoshiwo staff 1132 Feb 19 15:35 Gemfile.lock
drwxr-xr-x 3 yoshiwo staff   96 Feb 10 20:23 dir_for_nlink
-rw---x--x 2 yoshiwo staff    0 Jan 22 05:38 file.txt
-rw---x--x 2 yoshiwo staff    0 Jan 22 05:38 link_to_file
-rw---x--x 1 yoshiwo staff 1193 Feb 18 17:19 ls_l_all_parts.rb
-rw---x--x 2 yoshiwo staff    0 Jan 22 05:38 new_link
-rw---x--x 2 yoshiwo staff    6 Feb 10 17:33 nlink_file.txt
-rw---x--x 2 yoshiwo staff    6 Feb 10 17:33 nlink_file_link.txt
-rw---x--x 1 yoshiwo staff  109 Feb 18 15:07 stat_filename_check.rb
-rw---x--x 1 yoshiwo staff  241 Feb 14 13:32 stat_group_check.rb
-rw---x--x 1 yoshiwo staff  404 Feb 11 15:11 stat_link_check.rb
-rw---x--x 1 yoshiwo staff  548 Feb 18 14:16 stat_mtime_check.rb
-rw---x--x 1 yoshiwo staff  313 Feb 12 20:38 stat_owner_check.rb
-rw---x--x 1 yoshiwo staff  495 Feb  2 18:39 stat_perm_check.rb
-rw---x--x 1 yoshiwo staff  256 Feb 14 14:58 stat_size_check.rb
-rw---x--x 1 yoshiwo staff  115 Feb 19 18:43 stat_total_check.rb
-rw---x--x 1 yoshiwo staff  282 Feb 18 16:27 stat_type_check.rb
drwxr-xr-x 2 yoshiwo staff   64 Jan 22 05:38 test_dir
```
ちゃんと表示されている。
これで提出してみよう！

</details>


---


## ✍🏻 感想
### ✨ 課題提出 
`rubocop-fjord`のコードチェックをなんとかパスし、提出まで辿り着けました。達成感もありますが、それ以上に悔しさの方が大きいです。思ったより時間がかかってしまい、今の自分の実力不足を痛感しました。

先日のグループコーチングでも発表しましたが、強くなるには勉強するしかありません。インプット & アウトプットの量を増やしつつ、もう少し効率よく理解を深められるように工夫していきます。


---


### ⏰ 学習時間
- Today:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5 hours 01 min
- Total: 1502 hours 12 min
